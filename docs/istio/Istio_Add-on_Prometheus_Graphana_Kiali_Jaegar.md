# First Create Kiali secrets before enabling add-on
## Kiali - Visualizing Your Mesh using Kiali and create Secrets.
This task shows you how to visualize different aspects of your Istio mesh.
Kiali is an observability console for Istio with service mesh configuration capabilities.
This task uses the Bookinfo sample application as the example throughout.
**Before you begin** **Create a secret**
The following instructions assume you have installed istioctl and will use it 
to install Kiali.
Ref. - https://istio.io/docs/tasks/observability/kiali/

**Create a secret in your Istio namespace with the credentials that you use to 
authenticate to Kiali.**
First, define the credentials you want to use as the Kiali username and passphrase.

- Enter a Kiali username when prompted:


    KIALI_USERNAME=$(read -p 'Kiali Username: ' uval && echo -n $uval | base64)
    
- Enter a Kiali passphrase when prompted:


    KIALI_PASSPHRASE=$(read -sp 'Kiali Passphrase: ' pval && echo -n $pval | base64)

- To create a secret, run the following commands:

    
    NAMESPACE=istio-system
    kubectl create namespace $NAMESPACE
    
    cat <<EOF | kubectl apply -f -
    apiVersion: v1
    kind: Secret
    metadata:
      name: kiali
      namespace: $NAMESPACE
      labels:
        app: kiali
    type: Opaque
    data:
      username: $KIALI_USERNAME
      passphrase: $KIALI_PASSPHRASE
    EOF

# Istio Add-on

To enable add-on's e.g. the Grafana dashboard on top of the default profile, 
Prometheus Kiali and Jaegar, use following steps.

## Prometheus - on Istio
About the Prometheus add-on
Mixer comes with a built-in Prometheus adapter that exposes an endpoint 
serving generated metric values. The Prometheus add-on is a Prometheus server 
that comes preconfigured to scrape Mixer endpoints to collect the exposed metrics. 
It provides a mechanism for persistent storage and querying of Istio metrics.

The configured Prometheus add-on scrapes the following endpoints:
1.	istio-telemetry.istio-system:42422: The istio-mesh job returns all 
    Mixer-generated metrics.
2.	istio-telemetry.istio-system:15014: The istio-telemetry job returns all 
    Mixer-specific metrics. Use this endpoint to monitor Mixer itself.
3.	istio-proxy:15090: The envoy-stats job returns raw stats generated by 
    Envoy. Prometheus is configured to look for pods with the envoy-prom endpoint exposed. The add-on configuration filters out a large number of envoy metrics during collection in an attempt to limit the scale of data by the add-on processes.
4.	istio-pilot.istio-system:15014: The pilot job returns the Pilot-generated metrics.
5.	istio-galley.istio-system:15014: The galley job returns the Galley-generated metrics.
6.	istio-policy.istio-system:15014: The istio-policy job returns all policy-related 
    metrics.
7.	istio-citadel.istio-system:15014: The istio-citadel job returns all 
    Citadel-generated metrics.

**set the addonComponents.prometheus.enabled configuration parameter**
with following command,

    istioctl manifest apply --set addonComponents.prometheus.enabled=true
    
    # Output 
    padmakar_kotule@cloudshell:~/bookinfo-lab/istio-1.5.2$ istioctl manifest apply --set addonComponents.prometheus.enabled=true
    - Applying manifest for component Base...
    ✔ Finished applying manifest for component Base.
    - Applying manifest for component Pilot...
    ✔ Finished applying manifest for component Pilot.
    - Applying manifest for component AddonComponents...
    - Applying manifest for component IngressGateways...
    ✔ Finished applying manifest for component IngressGateways.
    ✔ Finished applying manifest for component AddonComponents.
    ✔ Installation complete
    padmakar_kotule@cloudshell:~/bookinfo-lab/istio-1.5.2$

You can also access from console, but need to expose port and then access it.

## Accessing The Grafana Service (Istio System using Grafana)
Ref. Link - https://www.magalix.com/blog/working-with-istio-track-your-services-with-kiali

    istioctl manifest apply --set addonComponents.grafana.enabled=true

**Since Prometheus is, by default, an internal service, you can access it in 
either of two ways:**

**1 - Using port forwarding**

    
    kubectl -n istio-system port-forward \
    $(kubectl -n istio-system get pod -l app=prometheus -o jsonpath='{.items[0].metadata.name}') 9090:9090
    # Above command is from Qwiklab
    #kubectl -n istio-system port-forward svc/prometheus 9090:9090
    
**2 - Convert the service to LoadBalancer**

    # Convert Grafana to LoadBalancer service
    kubectl patch service grafana --patch '{"spec":{"type":"LoadBalancer"}}' -n istio-system
        
    # verify prometheus Before converting to LoadBalancer
    # kubectl -n istio-system get svc prometheus
    padmakar_kotule@cloudshell:~/istio/istio-1.5.2 (devops-padmakar)$ kubectl -n istio-system get svc prometheus
    NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
    prometheus   ClusterIP   10.43.252.202   pending       9090/TCP   88m
    padmakar_kotule@cloudshell:~/istio/istio-1.5.2 (devops-padmakar)$
    
    # verify prometheus After converting to LoadBalancer, it will get External IP
    # kubectl -n istio-system get svc prometheus
    padmakar_kotule@cloudshell:~/istio/istio-1.5.2 (devops-padmakar)$ kubectl -n istio-system get svc prometheus
    NAME         TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)          AGE
    prometheus   LoadBalancer   10.43.252.202   104.197.188.205   9090:32042/TCP   89m
    padmakar_kotule@cloudshell:~/istio/istio-1.5.2 (devops-padmakar)$

**Query Istio metrics with Prometheus**
In this task, you use Prometheus to view metrics for services as visualizations. 
This demo installation of Istio with Prometheus includes many metrics already. 
At the end of this task, a new metric, istio_double_request_count, will be 
enabled for calls to services within your mesh.
The Bookinfo sample application is used as the example application throughout this task.


## Graphana - on Istio
Grafana is an open source solution for running data analytics, pulling up metrics 
that make sense of the massive amount of data & to monitor our apps with the 
help of cool customizable dashboards.

**set the addonComponents.grafana.enabled configuration parameter** 
with the following command:

     istioctl manifest apply --set addonComponents.grafana.enabled=true
     
     #Output
     padmakar_kotule@cloudshell:~/bookinfo-lab/istio-1.5.2$ istioctl manifest apply --set addonComponents.grafana.enabled=true
        - Applying manifest for component Base...
        ✔ Finished applying manifest for component Base.
        - Applying manifest for component Pilot...
        ✔ Finished applying manifest for component Pilot.
          Waiting for resources to become ready...
          Waiting for resources to become ready...
        - Applying manifest for component IngressGateways...
        - Applying manifest for component AddonComponents...
        ✔ Finished applying manifest for component IngressGateways.
        ✔ Finished applying manifest for component AddonComponents.   
        ✔ Installation complete
    padmakar_kotule@cloudshell:~/bookinfo-lab/istio-1.5.2$

In general, you can use the --set flag in istioctl as you would with Helm. 
The only difference is you must prefix the setting paths with values. because this 
is the path to the Helm pass-through API in the IstioOperator API.

## Accessing The Grafana Service (Istio System using Grafana)
Ref. Link - https://www.magalix.com/blog/working-with-istio-track-your-services-with-kiali

**Since Grafana is, by default, an internal service, you can access it in either of two ways:**

**1 - Using port forwarding**

    kubectl -n istio-system port-forward svc/grafana  30000:3000
    
**2 - Convert the service to LoadBalancer**

    kubectl patch service grafana --patch '{"spec":{"type":"LoadBalancer"}}' -n istio-system

    # Then get the IP address and port:
    #kubectl -n istio-system get service grafana -o jsonpath='{.status.loadBalancer.ingress[0].ip}
    #kubectl -n istio-system get service grafana -o jsonpath='{.spec.ports[?(@.name=="http-kiali")].port}'    
    
    kubectl -n istio-system get svc grafana

Navigate to the Grafana URL 

    for example, http://<Grafana-load-balance-IP>:3000/dashboard/db/istio-mesh-dashboard
    http://34.71.126.82:3000/dashboard/db/istio-mesh-dashboard
    you should see a page:
There are different dashboards, for more details pl. visit, 
https://istio.io/docs/tasks/observability/metrics/using-istio-dashboard/

Services dashboard e.g.

    http://localhost:3000/dashboard/db/istio-service-dashboard 
    e.g.
    http://34.71.126.82:3000/dashboard/db/istio-service-dashboard

Visualize Workload Dashboards

    http://localhost:3000/dashboard/db/istio-workload-dashboard
    http://34.71.126.82:3000/dashboard/db/istio-workload-dashboard 

Examples, 
http://34.71.126.82:3000/dashboard/db/istio-service-dashboard
http://34.71.126.82:3000/dashboard/db/istio-mesh-dashboard
http://34.71.126.82:3000/dashboard/db/istio-workload-dashboard   
        



## Kiali - Enable addon

**set the addonComponents.kiali.enabled configuration parameter**
with following command,

    istioctl manifest apply --set addonComponents.kiali.enabled=true
    
    # Output 
    padmakar_kotule@cloudshell:~/bookinfo-lab/istio-1.5.2$ istioctl manifest apply --set addonComponents.kiali.enabled=true
    - Applying manifest for component Base...
    ✔ Finished applying manifest for component Base.
    - Applying manifest for component Pilot...
    ✔ Finished applying manifest for component Pilot.
    - Applying manifest for component AddonComponents...
    - Applying manifest for component IngressGateways...
    ✔ Finished applying manifest for component IngressGateways.
    ✔ Finished applying manifest for component AddonComponents.
    ✔ Installation complete
    padmakar_kotule@cloudshell:~/bookinfo-lab/istio-1.5.2$

## Accessing The Kiali Service
Ref. Link - https://www.magalix.com/blog/working-with-istio-track-your-services-with-kiali

**Since Kiali is, by default, an internal service, you can access it in either of two ways:**

**1 - Using port forwarding**

    kubectl -n istio-system port-forward svc/kiali  20001:20001
    
**2 - Convert the service to LoadBalancer**

    kubectl patch service kiali --patch '{"spec":{"type":"LoadBalancer"}}' -n istio-system
    
    # Then get the IP address and port:
    #kubectl -n istio-system get service kiali -o jsonpath='{.status.loadBalancer.ingress[0].ip}
    #kubectl -n istio-system get service kiali -o jsonpath='{.spec.ports[?(@.name=="http-kiali")].port}'    

    kubectl -n istio-system get svc kiali
    
Navigate to the Kiali URL 

    for example, http://<Kiali-load-balance-IP>:20001/kiali/
    http://52.150.35.253:20001/kiali/
    you should see a page:

**Jaeger**
Jaeger is open source, end-to-end distributed tracing.
**Need to check - set the addonComponents.trace.enabled configuration parameter**
with following command,

    ## need to check - istioctl manifest apply --set addonComponents.tracing.enabled=true
    
    # Output
    
You can also access from console, but need to expose port and then access it.

    # from console only - istioctl dashboard jaeger
    
## Accessing The Jaeger Service
Ref. Link - https://www.magalix.com/blog/working-with-istio-track-your-services-with-kiali

    # First enable tracing if not already or check it. 
    istioctl manifest apply --set addonComponents.tracing.enabled=true
    # Enable addon component Jaeger-query and access using web.
    istioctl manifest apply --set addonComponents.jaeger-query.enabled=true    
    kubectl patch service jaeger-query --patch '{"spec":{"type":"LoadBalancer"}}' -n istio-system
    kubectl -n istio-system get svc Jaeger-query    


**Since Jaeger is, by default, an internal service, you can access it in either of two ways:**
**1 - Using port forwarding**

    kubectl -n istio-system port-forward svc/jaeger-query  16686:30092
    
**2 - Convert the service to LoadBalancer**

    kubectl patch service jaeger-query --patch '{"spec":{"type":"LoadBalancer"}}' -n istio-system
    
    # Then get the IP address and port:
    kubectl -n istio-system get service kiali -o jsonpath='{.status.loadBalancer.ingress[0].ip}
    kubectl -n istio-system get service kiali -o jsonpath='{.spec.ports[?(@.name=="http-kiali")].port}'    

Or
    # Run following command and copy external IP address and port
    
    kubectl -n istio-system get service jaeger-query
    
    E.g.
    padmakar_kotule@cloudshell:~ (devops-padmakar)$ kubectl -n istio-system get service jaeger-query
    NAME           TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)           AGE
    jaeger-query   LoadBalancer   10.19.246.172   104.155.149.65   16686:30092/TCP   9h
    padmakar_kotule@cloudshell:~ (devops-padmakar)$
    
    
Navigate to the Jaeger URL 
    http://104.155.149.65:16686
    you should see a page:
